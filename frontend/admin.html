<!--
	This file contains all functionality related to faculty administrative abilities, such as:
	Checks to see if user has proper privileges to be here with session ids or cookies
	Interacts with backend API to update, delete, or add new items to the database
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Faculty Admin Page</title> 
	<link rel = "stylesheet" href = "style.css" />
	<script src='http://code.jquery.com/jquery-latest.js' type="text/javascript"></script>
	<script>
		/*
			This script checks to see if the user has high enough permissions to be here
		*/
		//Function to get stored values in either cookies or local storage for form
		function getStoredValues(which){
		   //check if supports local storage
		   if(window.localStorage){
		   	if(localStorage.getItem(which)){
		   	  	return localStorage.getItem(which);	
		     }else{
			  return -1;
		     }
		   }else{//use cookies if it doesn't
		   	    if(GetCookie(which)!=null){
			   	    return GetCookie(which);
		   	    }else{
		   	   		return -1;
		      	}
		   }
		}
		if(getStoredValues('accessHash') == -1){
			//User is not logged in, redirect to login
			window.location.href="http://final.alexwacker.com/ISTE330-Project/frontend/login.html";
		}else{
			//User is logged in, verify that they have the privileges to be here
			$.ajax({
				type:'get',
				url:'proxy.php',
				async:true,
				cache:false,
				data:{path:'/User/'+getStoredValues('uid')},
				dataType:'json',
				success:function(data)
				{
					if(data[0].user_type_id != 1){
						alert("You do not have acess to the admin area");
						window.location.href="http://final.alexwacker.com/ISTE330-Project/frontend/index.html";
					}
				}
			});
		}	
	</script>
	<script src='http://cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js' type="text/javascript"></script>
	<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js' type="text/javascript"></script>
	<script src='spin.min.js' type="text/javascript"></script>
	<script src='jquery.spin.js' type="text/javascript"></script>
	<script src='bootbox.min.js' type="text/javascript"></script>
	<script src='http://cdn.jsdelivr.net/jquery.validation/1.13.1/jquery.validate.min.js' type="text/javascript"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.6/css/jquery.dataTables.min.css">
	<style>
		.paperforms
		{
			float: left;
		}
		
		#search{
			height:40px;
			font-size: 15pt;
		}
		#content{
			position: relative;
			top: 50%;
			left: 50%;
			margin-left: -200px;
		}
		body{
			background-color: #f0f0f0;
		}
		.pointer{
			cursor:pointer;
		}
		.modal-body{
			min-height: 600px;
			overflow-y: auto;
		}
		#loginButton {
		color: #fff;
		background-color: #6496c8;
		text-shadow: -1px 1px #417cb8;
		border: none;
		position:absolute; 
		top:0; 
		right:0;
		}
	</style>
	<style>
	cbp-hrmenu {
		width: 100%;
		margin-top: 2em;
		border-bottom: 4px solid #47a3da;
	}
	
	/* general ul style */
	.cbp-hrmenu ul {
		margin: 0;
		padding: 0;
		list-style-type: none;
	}
	
	/* first level ul style */
	.cbp-hrmenu > ul,
	.cbp-hrmenu .cbp-hrsub-inner {
		width: 90%;
		max-width: 70em;
		margin: 0 auto;
		padding: 0 1.875em;
	}
	
	.cbp-hrmenu > ul > li {
		display: inline-block;
	}
	
	.cbp-hrmenu > ul > li > a {
		font-weight: 700;
		padding: 1em 2em;
		color: #999;
		display: inline-block;
	}
	
	.cbp-hrmenu > ul > li > a:hover {
		color: #47a3da;
	}
	
	.cbp-hrmenu > ul > li.cbp-hropen a,
	.cbp-hrmenu > ul > li.cbp-hropen > a:hover {
		color: #fff;
		background: #47a3da;
	}
	
	/* sub-menu */
	.cbp-hrmenu .cbp-hrsub {
		display: none;
		position: absolute;
		background: #47a3da;
		width: 100%;
		left: 0;
	}
	
	.cbp-hropen .cbp-hrsub {
		display: block;
		padding-bottom: 3em;
	}
	
	.cbp-hrmenu .cbp-hrsub-inner > div {
		width: 33%;
		float: left;
		padding: 0 2em 0;
	}
	
	.cbp-hrmenu .cbp-hrsub-inner:before,
	.cbp-hrmenu .cbp-hrsub-inner:after {
		content: " ";
		display: table;
	}
	
	.cbp-hrmenu .cbp-hrsub-inner:after {
		clear: both;
	}
	
	.cbp-hrmenu .cbp-hrsub-inner > div a {
		line-height: 2em;
	}
	
	.cbp-hrsub h4 {
		color: #afdefa;
		padding: 2em 0 0.6em;
		margin: 0;
		font-size: 160%;
		font-weight: 300;
	}
	
	/* Examples for media queries */
	
	@media screen and (max-width: 52.75em) { 
	
		.cbp-hrmenu {
			font-size: 80%;
		}
	
	}
	
	@media screen and (max-width: 43em) { 
	
		.cbp-hrmenu {
			font-size: 120%;
			border: none;
		}
	
		.cbp-hrmenu > ul,
		.cbp-hrmenu .cbp-hrsub-inner {
			width: 100%;
			padding: 0;
		}
	
		.cbp-hrmenu .cbp-hrsub-inner {
			padding: 0 2em;
			font-size: 75%;
		}
	
		.cbp-hrmenu > ul > li {
			display: block;
			border-bottom: 4px solid #47a3da;
		}
	
		.cbp-hrmenu > ul > li > a { 
			display: block;
			padding: 1em 3em;
		}
	
		.cbp-hrmenu .cbp-hrsub { 
			position: relative;
		}
	
		.cbp-hrsub h4 {
			padding-top: 0.6em;
		}
	
	}
	
	@media screen and (max-width: 36em) { 
		.cbp-hrmenu .cbp-hrsub-inner > div {
			width: 100%;
			float: none;
			padding: 0 2em;
		}
	}	
	</style>
	<script type="text/javascript">
		/*
			This script handles the "looks" of the page, no database functionality here
		*/
		var cbpHorizontalMenu = (function() {
	
		var $listItems = $( '#cbp-hrmenu > ul > li' ),
			$menuItems = $listItems.children( 'a' ),
			$body = $( 'body' ),
			current = -1;
	
		function init() {
			$menuItems.on( 'click', open );
			$listItems.on( 'click', function( event ) { event.stopPropagation(); } );
		}
	
		function open( event ) {
	
			if( current !== -1 ) {
				$listItems.eq( current ).removeClass( 'cbp-hropen' );
			}
	
			var $item = $( event.currentTarget ).parent( 'li' ),
				idx = $item.index();
	
			if( current === idx ) {
				$item.removeClass( 'cbp-hropen' );
				current = -1;
			}
			else {
				$item.addClass( 'cbp-hropen' );
				current = idx;
				$body.off( 'click' ).on( 'click', close );
			}
	
			return false;
	
		}
	
		function close( event ) {
			$listItems.eq( current ).removeClass( 'cbp-hropen' );
			current = -1;
		}
	
		return { init : init };
	
		})();
	</script>
	<script type="text/javascript">
		/*
			This script handles the interactions with our back end API when the user attempts an action
		*/
		//loads papers into select menus when page is loaded
		$(document).ready(function()
		{
			if(getStoredValues('accessHash') != -1){
				$("#loginButton").val('Logout');
					$('#loginButton').prop('onclick',null).off('click');
					$('#loginButton').click(function() {
					   alert("logged out");  
					   localStorage.clear();
					   window.location.href="http://final.alexwacker.com/ISTE330-Project/frontend/index.html";
					});
			}
			
			loadPapers(true);
			
			$("a.papers-button").click(function(){
				$("#papers-panel").html("<form class='paperforms'>".
					"<fieldset>".
						"<legend>Edit Paper</legend>".
						"<select id='paperselect' onchange='loadPapers();'>".
						"</select><br />".
						"<label class = 'admin' for = 'title'>Paper Title: <input type = 'text' id = 'title' name = 'title' size = '50'><br />".
						"<label class = 'admin' for = 'abstract'>Abstract: <input type = 'text' id = 'abstract' name = 'abstract' size = '50'><br />".
						"<label class = 'admin' for = 'citation'>Citation: <input type = 'text' id = 'citation' name = 'citation' size = '50'><br />".
						"<label class = 'admin' for = 'currentnum'>Current Number of People: <input type = 'text' id = 'currentnum' name = 'currentnum' size = '50'><br />".
						"<label class = 'admin' for = 'currentnum'>Maximum Number of People: <input type = 'text' id = 'maxnum' name = 'maxnum' size = '50'><br />".
						"<label class = 'admin' for = 'updatebutton'>Update Paper: <button id='updatebutton' type='button' onclick='updatePaper();'>Update</button>".
					"</fieldset>".
				"</form>".
				"<form class='paperforms'>".
					"<fieldset>".
						"<legend>Add Paper</legend>".
						"<label class = 'admin' for = 'title2'>Paper Title: <input type = 'text' id = 'title2' name = 'title2' size = '50'><br />".
						"<label class = 'admin' for = 'abstract2'>Abstract: <input type = 'text' id = 'abstract2' name = 'abstract2' size = '50'><br />".
						"<label class = 'admin' for = 'citation2'>Citation: <input type = 'text' id = 'citation2' name = 'citation2' size = '50'><br />".
						"<label class = 'admin' for = 'currentnum2'>Current Number of People: <input type = 'text' id = 'currentnum2' name = 'currentnum2' size = '50'><br />".
						"<label class = 'admin' for = 'currentnum2'>Maximum Number of People: <input type = 'text' id = 'maxnum2' name = 'maxnum2' size = '50'><br />".
						"<label class = 'admin' for = 'addbutton'>Add Paper: <button id='addbutton' type='button' onclick='addPaper();'>Add</button>".
					"</fieldset>".
				"</form>".
				"<form class='paperforms'>".
					"<fieldset>".
						"<legend>Delete Paper</legend>".
						"<select id='deleteselect'>".
						"</select><br />".
						"<label class = 'admin' for = 'deletebutton'>Delete Paper: <button id='deletebutton' type='button' onclick='deletePaper();'>Delete</button>".
					"</fieldset>".
				"</form>");
				$("#people-panel").html("");
				$("#keywords-panel").html("");
			});
			
			$("a.people-button").click(function(){
				$("#people-panel").html("This is a test for the people tab.");
				$("#papers-panel").html("");
				$("#keywords-panel").html("");
			});
			
			$("a.keywords-button").click(function(){
				$("#keywords-panel").html("This is a test for the people tab.");
				$("#people-panel").html("");
				$("#papers-panel").html("");
			});
		});
		
		//dynamically loads papers from database into the select menus on the page
		function loadPapers(firstTime)
		{
			$.ajax({
				type:'get',
				url:'proxy.php',
				async:true,
				cache:false,
				data:{path:'/Paper'},
				dataType:'json',
				success:function(data)
				{

					//add options from database if first time method is called
					if(firstTime == true)
					{
						$("#deleteselect").html('');
						$("#paperselect").html('');
						
						$.each(data,function(index,element)
						{
							//fill edit select menu
							var optEle = document.createElement('option');
							var val = element.paper_id;
							optEle.setAttribute('value', val);
							optEle.appendChild(document.createTextNode(element.title));
							document.getElementById("paperselect").appendChild(optEle);
							//fill delete select menu
							var optEle2 = document.createElement('option');
							var val2 = element.paper_id;
							optEle2.setAttribute('value', val2);
							optEle2.appendChild(document.createTextNode(element.title));
							document.getElementById("deleteselect").appendChild(optEle2);
						});
						//firstTime = 'false';
					}
					//populate edit form
					for(var i=0; i<document.getElementById("paperselect").childNodes.length; i++)
					{
						if(document.getElementById("paperselect").childNodes[i].selected)
						{
							$.ajax({
								type:'get',
								url:'proxy.php',
								async:true,
								cache:false,
								data:{path:'/Paper/'+document.getElementById("paperselect").childNodes[i].getAttribute("value")},
								dataType:'json',
								success:function(data)
								{
									$.each(data,function(index,element)
									{
										document.getElementById("title").value = element.title;
										document.getElementById("abstract").value = element.abstract;
										document.getElementById("citation").value = element.citation;
										document.getElementById("currentnum").value = element.current_people;
										document.getElementById("maxnum").value = element.max_people;
									});
								},
								error:function(jqXHR, textStatus, errorThrown) 
								{
									//console.dir(jqXHR);
								}
							});
						}
					}
				},
				error:function(jqXHR, textStatus, errorThrown) 
				{
					//console.dir(jqXHR);
				}
			});
		}
		
		//updates a record in the database when update button is clicked
		function updatePaper()
		{
			for(var i=0; i<document.getElementById("paperselect").childNodes.length; i++)
			{
				if(document.getElementById("paperselect").childNodes[i].selected)
				{
					var obj = {'title': document.getElementById("title").value, 'abstract': document.getElementById("abstract").value, 'citation': document.getElementById("citation").value, 'current_people': document.getElementById("currentnum").value, 'max_people': document.getElementById("maxnum").value}
					$.ajax({
						type:'put',
						url:'http://final.alexwacker.com/ISTE330-Project/API/Paper/'+document.getElementById("paperselect").childNodes[i].getAttribute("value"),
						async:true,
						cache:false,
						data: obj,
						//contentType:'application/json',
						success:function(data)
						{
								alert("Paper Updated");
						},
						error:function(jqXHR, textStatus, errorThrown) 
						{
							alert("Paper Updated");
						}
					});
				}
			}
		}
		
		//adds a record to the database when the add button is clicked
		function addPaper()
		{
			var obj = {'title': document.getElementById("title2").value, 'abstract': document.getElementById("abstract2").value, 'citation': document.getElementById("citation2").value, 'current_people': document.getElementById("currentnum2").value, 'max_people': document.getElementById("maxnum2").value}
			$.ajax({
				type:'post',
				url:'http://final.alexwacker.com/ISTE330-Project/API/Paper',
				async:true,
				cache:false,
				data: obj,
				//contentType:'application/json',
				success:function(data)
				{
					alert("Paper Added");
					loadPapers(true);
				},
				error:function(jqXHR, textStatus, errorThrown) 
				{
					//console.dir(jqXHR);
				}
			});
		}
		
		//deletes a paper from the database when the delete button is clicked
		function deletePaper()
		{
			for(var i=0; i<document.getElementById("deleteselect").childNodes.length; i++)
			{
				if(document.getElementById("deleteselect").childNodes[i].selected)
				{
					$.ajax({
						type:'delete',
						url:'http://final.alexwacker.com/ISTE330-Project/API/Paper/'+document.getElementById("deleteselect").childNodes[i].getAttribute("value"),
						async:true,
						cache:false,
						//contentType:'application/json',
						success:function(data)
						{
							loadPapers(true);
						},
						error:function(jqXHR, textStatus, errorThrown) 
						{
							alert("Paper deleted");
							loadPapers(true);
						}
					});
				}
			}
		}
	</script>
</head>
<body>
	<input value="Login" id="loginButton" class="button" type="button" onclick="window.location='login.html';">
	<h1 style="padding-left: 645px;">Admin Page</h1>
<nav id="cbp-hrmenu" class="cbp-hrmenu">
	<ul>
		<li><a href="index.html">Search Database</a></li>
		<li><a href="admin.html">Faculty Admin</a></li>
		<!-- ... -->
	</ul>
</nav>
	<ul id = 'navigation'>
		<li><span id = 'papers-button'>Papers</span></li>
		<li><span id = 'people-button'>People</span></li>
		<li><span id = 'keywords-button'>Keywords</span></li>
	</ul>
	<div id = "papers-panel">
        <form class="paperforms">
        	<fieldset>
        		<legend>Edit Paper</legend>
			 	<select id="paperselect" onchange="loadPapers();">
				</select><br />
				<label class = 'admin' for = "title">Paper Title: <input type = "text" id = "title" name = "title" size = "50"><br />
				<label class = 'admin' for = "abstract">Abstract: <input type = "text" id = "abstract" name = "abstract" size = "50"><br />
				<label class = 'admin' for = "citation">Citation: <input type = "text" id = "citation" name = "citation" size = "50"><br />
				<label class = 'admin' for = "currentnum">Current Number of People: <input type = "text" id = "currentnum" name = "currentnum" size = "50"><br />
				<label class = 'admin' for = "currentnum">Maximum Number of People: <input type = "text" id = "maxnum" name = "maxnum" size = "50"><br />
				<label class = 'admin' for = "updatebutton">Update Paper: <button id="updatebutton" type="button" onclick="updatePaper();">Update</button>
            </fieldset>
        </form>
		<form class="paperforms">
        	<fieldset>
        		<legend>Add Paper</legend>
				<label class = 'admin' for = "title2">Paper Title: <input type = "text" id = "title2" name = "title2" size = "50"><br />
				<label class = 'admin' for = "abstract2">Abstract: <input type = "text" id = "abstract2" name = "abstract2" size = "50"><br />
				<label class = 'admin' for = "citation2">Citation: <input type = "text" id = "citation2" name = "citation2" size = "50"><br />
				<label class = 'admin' for = "currentnum2">Current Number of People: <input type = "text" id = "currentnum2" name = "currentnum2" size = "50"><br />
				<label class = 'admin' for = "currentnum2">Maximum Number of People: <input type = "text" id = "maxnum2" name = "maxnum2" size = "50"><br />
				<label class = 'admin' for = "addbutton">Add Paper: <button id="addbutton" type="button" onclick="addPaper();">Add</button>
            </fieldset>
        </form>
		<form class="paperforms">
        	<fieldset>
        		<legend>Delete Paper</legend>
			 	<select id="deleteselect">
				</select><br />
				<label class = 'admin' for = "deletebutton">Delete Paper: <button id="deletebutton" type="button" onclick="deletePaper();">Delete</button>
            </fieldset>
        </form>
    </div>
</body>
</html>
